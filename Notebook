15/01/12

mv desired files from computer to rosalind server

using ssh 
#already installed hisat2 and samtools programs onto /tools in home directory 

#all of files are placed into NSC_ESC folder

#testing the first file by 1) renaming txt.gz file to fastq.gz file 
mv 13799X1_161209_D00294_0278_BCAEAJANXX_1.txt.gz 13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz

zcat 13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz | head -5

@HWI-D00294:278:CAEAJANXX:1:1101:1085:1978 1:N:0:TGACCA
GGCTNACACTACTCACTCACAATTCACCACAATGGGAAGCAGATCCATGC
+
CCCC#@EFFGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG

zcat 13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz | grep @HWI-D00294:278:CAEAJANXX:1:1101:1085:1978 

#only returns one value so, not a merged .txt.gz file 

zcat 13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz | grep @HWI-D00294 | head -100000  | sort | uniq -c | sort -rgk 1,1 | head
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9999:18579 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9999:16743 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9999:11887 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9998:4795 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9998:2846 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9998:19538 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9998:13368 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9997:6142 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9997:5539 1:N:0:TGACCA
      1 @HWI-D00294:278:CAEAJANXX:1:1101:9997:2281 1:N:0:TGACCA
      
 #notice only 1:N:0:TGACCA so means single end 
 #does mean worse coverage but is cheaper so that why it was done
 
 #whilst in the mnt/lustre/users/k.... files use 
 ##Each of the HISAT2 indexes available here on the website comes with a shell script (e.g. make_grch38.sh) that provides instructions (or shell commands) for downloading a reference sequence, gene annotations, and SNPs, and building a HISAT2 index.  You can use the script to build the same HISAT2 index we provide.
#don't need to create own 
wget ftp://ftp.ccb.jhu.edu/pub/infphilo/hisat2/data/grcm38.tar.gz
 
 gunzip grcm38.tar.gz
 tar -xvf grcm38.tar 
 
 #do trial alignment and conversion of sam to bam
hisat2 --dta -x grcm38_snp_tran/genome_tran -U ESC_NSC/13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz -S | samtools view -bS > 13799X1_1.bam 


hisat2 --dta -x grcm38/genome -U ESC_NSC/13799X1_161209_D00294_0278_BCAEAJANXX_1.fastq.gz -S | samtools view -bS > 13799X1_1.bam 
52586374 reads; of these:
  52586374 (100.00%) were unpaired; of these:
    3349906 (6.37%) aligned 0 times
    38497861 (73.21%) aligned exactly 1 time
    10738607 (20.42%) aligned >1 times
93.63% overall alignment rate

#IT WORKED!!!!

#do trial for loop
#!/bin/bash                                                                                                                                                                                              
for FILE in /mnt/lustre/users/k1632479/ESC_NSC/*.txt.gz; do
    echo $FILE
done

#do a loop to change all .txt.gz files into .fastq.gz Saved as bashtest
#!/bin/bash                                                                                                                                                                                              
DIR="/mnt/lustre/users/k1632479/ESC_NSC/"
for FILE in "$DIR"*.txt.gz; do
mv "$FILE" "${FILE/%.txt.gz/.fastq.gz}"; done

#Extend for loop to qsub the rest of the alignments
#!/bin/bash                                                                                                                                                                                              
DIR="/mnt/lustre/users/k1632479/"
for FILE in "$DIR/ESC_NSC"*.fastq.gz; do
hisat2 --dta -x "$DIR/grcm38/genome" -U "$FILE" -S | samtools view -bS > "${FILE/%.sam/.bam}"; done



#create a new run file
#!/bin/bash
module load hisat2
module load_gsnap.samtools
DBDIR="/path/containing/HiSat2_index_files"
GENOME="Gmax_275_v2.0_hisat2"
# number of processors to use
p=16
R1_FQ="$1"
R2_FQ="$2"
# output file prefix (uses a portion of the fastq filename, but can be changed if these are not unique)
OUTPUT=$(basename ${R1_FQ} |cut -f 1 -d "_");
# run the HiSat2 aligner
hisat2 \
  -p ${p} \
  -x ${DBDIR}/${GENOME} \
  -1 ${R1_FQ} \
  -2 ${R2_FQ} | \
  -S  ${OUTPUT}_gsnap.sam &> ${OUTPUT}.log
# convert_gsnap.same file to bam file format
samtools view \
  --threads 16 \
  -b \
  -o ${OUTPUT}.bam \
     ${OUTPUT}_gsnap.sam
# sort the bam file based on co-ordinates
samtools sort \
  -m 7G \
  -o ${OUTPUT}_sorted.bam \
  -T ${OUTPUT}_temp \
  --threads 16 \
  ${OUTPUT}.bam
  
  #for loop 
  for fastq in *R1.fastq.gz; do
fastq2=$(echo $fastq | sed 's/R1.fastq.gz/R2.fastq.gz/g'); 
echo "./runHISAT2.sh ${fastq} ${fastq2}"; 
done > hisat2.cmds

makeSLURMs.py 1 hisat2.cmds
for sub in hisat2_*.sub; do
qsub $sub; 
done
 
#-p 2 : This tells hisat2 that it can use 2 CPU cores on the machine. Short read mapping scales very efficiently across cores so if you have more cores available then you should use them to speed up your analysis.
#-U : Specifies the fastq file of sequence reads to map. If you had paired end data and therefore 2 input files you would use -1 and -2 to specify the two files instead of –U
#-x : Specifies the index file to use – this is the basename for the index downloaded



#HISAT2 indexes named genome_tran or genome_snp_tran use Ensembl gene annotations, which include many more transcripts than RefSeq annotations, due to the inclusion of annotations as predicted by software.

#The HISAT2 indexes for the human genome include only primary assembly.  If you choose to include alternative sequences introduced in GRCh38 and build your own HISAT2 indexes, then please be aware that those alternative sequences are nearly identical to the primary assembly in GRCh38 and as a result some reads may map to many more locations compared to when using the primary assembly only.  HISAT2 often skips those multi-mapped reads if the number of potential locations is more than the value specified by the -k option.  You may want to use a higher value for the -k option to resolve the issue.
 #to begin with want a for loop from home directory to change .txt.gz files to .fastq.gz files
 
